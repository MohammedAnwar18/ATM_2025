<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Ù†Ø¸Ø§Ù… Ø§Ù„ØªØªØ¨Ø¹ Ø§Ù„Ø°ÙƒÙŠ Ù„ØµØ±Ø§ÙØ§Øª Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø¹Ø±Ø¨ÙŠ ÙÙŠ Ù…Ø­Ø§ÙØ¸Ø© Ø±Ø§Ù… Ø§Ù„Ù„Ù‡ ÙˆØ§Ù„Ø¨ÙŠØ±Ø©</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Arial, sans-serif; background: #000; overflow: hidden; height: 100vh; }
        #map { 
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
        }

        /* Navigation HUD - Made smaller and more compact */
        .navigation-hud { 
            position: absolute; 
            top: 15px; 
            left: 15px; 
            background: rgba(0, 0, 0, 0.85); 
            backdrop-filter: blur(15px); 
            color: white; 
            padding: 8px 12px; 
            border-radius: 12px; 
            border: 1px solid rgba(255, 255, 255, 0.15); 
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6); 
            z-index: 1000; 
            width: 200px;
            text-align: center; 
            font-size: 0.85rem;
        }
        .speed-indicator { 
            font-size: 1.4rem;
            font-weight: bold; 
            color: #00ff88; 
            text-shadow: 0 0 8px rgba(0, 255, 136, 0.4); 
            margin-bottom: 4px; 
        }
        .distance-info { 
            display: flex; 
            justify-content: space-between; 
            margin: 6px 0; 
            font-size: 0.75rem;
            align-items: center;
        }
        .eta-info { 
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%); 
            padding: 4px 8px; 
            border-radius: 8px; 
            margin: 4px 0; 
            font-size: 0.75rem;
        }

        /* Arab Bank ATM Panel */
        .atm-panel { 
            position: absolute; 
            top: 20px; 
            right: 20px; 
            background: rgba(0, 0, 0, 0.9); 
            backdrop-filter: blur(10px); 
            color: white; 
            padding: 15px; 
            border-radius: 15px; 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            z-index: 1000; 
            width: 280px; 
            text-align: center;
        }

        .location-panel { 
            position: absolute; 
            bottom: 100px; 
            left: 20px; 
            background: rgba(0, 0, 0, 0.9); 
            backdrop-filter: blur(10px); 
            color: white; 
            padding: 15px; 
            border-radius: 15px; 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            z-index: 1000; 
            width: 320px; 
        }
        
        /* Travel Mode Panel */
        .travel-mode-panel {
            position: absolute;
            top: 50%; 
            right: 20px; 
            transform: translateY(-50%); 
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            color: white;
            padding: 10px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            display: flex;
            flex-direction: column; 
            gap: 10px; 
            width: 70px; 
            align-items: center;
        }

        .travel-mode-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 10px;
            border-radius: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
            font-size: 1.8rem; 
            width: 50px; 
            height: 50px; 
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .travel-mode-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(102, 126, 234, 0.3);
        }

        .travel-mode-btn.active {
            background: linear-gradient(45deg, #00d2ff 0%, #3a7bd5 100%); 
            border-color: #00d2ff;
            box-shadow: 0 0 15px rgba(0, 210, 255, 0.5);
        }

        .btn-modern { 
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%); 
            border: none; 
            color: white; 
            padding: 10px 15px; 
            border-radius: 8px; 
            margin: 3px; 
            transition: all 0.3s ease; 
            font-weight: 500; 
        }
        .btn-modern:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); 
            color: white; 
        }
        .btn-danger-modern { 
            background: linear-gradient(45deg, #ff6b6b 0%, #ee5a24 100%); 
        }
        .btn-success-modern { 
            background: linear-gradient(45deg, #00d2ff 0%, #3a7bd5 100%); 
        }
        .form-control-modern { 
            background: rgba(255, 255, 255, 0.1); 
            border: 1px solid rgba(255, 255, 255, 0.2); 
            color: white; 
            border-radius: 8px; 
            padding: 8px 12px; 
        }
        .compass { 
            width: 50px; 
            height: 50px; 
            border-radius: 50%; 
            background: radial-gradient(circle, #667eea 0%, #764ba2 100%); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin: 10px auto; 
            position: relative; 
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.3); 
        }
        .compass::before { 
            content: 'â†‘'; 
            color: white; 
            font-size: 1.5rem; 
            font-weight: bold; 
        }
        .glow-text { 
            text-shadow: 0 0 10px currentColor; 
        }
        .info-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin: 8px 0; 
            padding: 5px 0; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
        }
        .info-label { 
            font-weight: 500; 
            opacity: 0.8; 
        }
        .info-value { 
            font-weight: bold; 
            color: #00ff88; 
        }

        /* Bottom Action Buttons */
        .bottom-actions {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 10px;
            z-index: 1000;
        }

        .contact-btn {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            min-width: 120px;
            text-align: center;
        }
        .contact-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        .email-btn {
            background: linear-gradient(45deg, #4e54c8, #8f94fb);
        }
        .emergency-btn {
            background: linear-gradient(45deg, #ff416c, #ff4b2b);
        }

        /* Right Action Buttons */
        .right-actions {
            position: absolute;
            bottom: 70px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }

        .action-btn {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        .export-btn {
            background: linear-gradient(45deg, #00d2ff, #3a7bd5);
        }
        .feedback-toggle {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        }

        /* Panels */
        .feedback-panel {
            position: absolute;
            bottom: 120px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            color: white;
            padding: 15px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1000;
            width: 300px;
            display: none;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
        }
        .feedback-panel h6 {
            color: #00ff88;
            margin-bottom: 10px;
            text-align: center;
        }
        .feedback-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .feedback-form select, .feedback-form textarea {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 6px;
            padding: 8px;
            font-size: 0.8rem;
        }
        .feedback-form textarea {
            resize: vertical;
            min-height: 60px;
        }
        .star-rating {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .star-rating i {
            color: #666;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
        }
        .star-rating i.active {
            color: gold;
        }

        /* Nearby Branches Panel */
        .branches-panel {
            position: absolute;
            top: 60px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            color: white;
            padding: 15px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1000;
            width: 300px;
            display: none;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
        }
        .branches-panel h6 {
            color: #00ff88;
            margin-bottom: 10px;
            text-align: center;
        }
        .branches-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .branch-item {
            padding: 8px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .branch-item:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .branch-distance {
            color: #00ff88;
            font-size: 0.8rem;
        }

        /* Emergency Numbers Panel */
        .emergency-panel {
            position: absolute;
            bottom: 70px;
            left: 20px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            color: white;
            padding: 15px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1000;
            width: 250px;
            display: none;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
        }
        .emergency-panel h6 {
            color: #ff416c;
            margin-bottom: 10px;
            text-align: center;
        }
        .emergency-item {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .emergency-name {
            font-weight: bold;
        }
        .emergency-number {
            color: #00ff88;
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .navigation-hud {
                width: 160px;
                padding: 6px 8px; 
                top: 10px; 
                left: 10px; 
                border-radius: 8px; 
                font-size: 0.75rem;
            }
            .speed-indicator {
                font-size: 1.1rem; 
                margin-bottom: 3px;
            }
            .distance-info {
                font-size: 0.65rem; 
                margin: 4px 0;
                flex-direction: column;
                gap: 2px;
            }
            .eta-info {
                padding: 3px 6px; 
                font-size: 0.65rem; 
                border-radius: 6px; 
            }

            .atm-panel {
                width: 140px; 
                right: 10px; 
                top: 10px; 
                padding: 8px; 
                border-radius: 10px; 
            }
            .atm-panel h6 {
                font-size: 0.8rem; 
                margin-bottom: 6px;
            }
            .btn-modern, .btn-success-modern, .btn-danger-modern { 
                padding: 6px 8px; 
                font-size: 0.7rem; 
                border-radius: 5px; 
            }
            .form-check-label {
                font-size: 0.7rem; 
            }

            .location-panel {
                width: 180px; 
                left: 10px; 
                bottom: 100px; 
                padding: 8px; 
                border-radius: 10px; 
            }
            .location-panel h6 {
                font-size: 0.8rem; 
                margin-bottom: 6px;
            }
            .info-item {
                margin: 4px 0; 
                padding: 2px 0;
            }
            .info-label, .info-value { 
                font-size: 0.7rem;
            }
            .compass {
                width: 35px; 
                height: 35px;
                margin-top: 6px;
            }
            .compass::before {
                font-size: 1rem; 
            }

            .travel-mode-panel {
                right: 8px; 
                padding: 6px;
                gap: 6px;
                width: 55px; 
            }
            .travel-mode-btn {
                font-size: 1.3rem; 
                width: 40px;
                height: 40px;
                padding: 6px;
            }

            .bottom-actions {
                bottom: 10px;
                gap: 5px;
            }
            .contact-btn {
                padding: 8px 12px;
                font-size: 0.7rem;
                min-width: 100px;
            }

            .right-actions {
                bottom: 60px;
                right: 10px;
            }
            .action-btn {
                padding: 6px 10px;
                font-size: 0.7rem;
            }

            .feedback-panel, .branches-panel {
                width: 250px;
                padding: 10px;
            }
            .emergency-panel {
                width: 220px;
            }
        }

        @media (max-width: 500px) {
            .navigation-hud {
                width: 140px; 
                padding: 4px 6px;
                font-size: 0.7rem; 
            }
            .speed-indicator {
                font-size: 1rem;
            }
            .distance-info {
                font-size: 0.6rem;
            }
            .eta-info {
                font-size: 0.6rem;
                padding: 2px 4px;
            }

            .atm-panel {
                width: 120px; 
                padding: 6px;
            }
            .atm-panel h6 {
                font-size: 0.7rem;
            }
            .btn-modern, .btn-success-modern, .btn-danger-modern {
                padding: 4px 6px; 
                font-size: 0.6rem; 
            }

            .location-panel {
                width: 140px; 
                padding: 6px;
            }
            .location-panel h6 {
                font-size: 0.7rem;
            }
            .info-label, .info-value {
                font-size: 0.65rem;
            }
            .compass {
                width: 30px; 
                height: 30px;
            }
            .compass::before {
                font-size: 0.8rem; 
            }

            .travel-mode-panel {
                right: 5px; 
                padding: 4px;
                gap: 4px;
                width: 45px; 
            }
            .travel-mode-btn {
                font-size: 1.1rem;
                width: 35px;
                height: 35px;
                padding: 4px;
            }

            .bottom-actions {
                bottom: 5px;
            }
            .contact-btn {
                padding: 6px 8px;
                font-size: 0.6rem;
                min-width: 80px;
            }

            .right-actions {
                bottom: 50px;
            }
            .action-btn {
                padding: 5px 8px;
                font-size: 0.6rem;
            }

            .feedback-panel, .branches-panel {
                width: 220px;
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="navigation-hud">
        <div class="speed-indicator glow-text" id="current-speed">0 ÙƒÙ…/Ø³</div>
        <div class="distance-info">
            <span>Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</span>
            <span id="remaining-distance" class="glow-text">-- ÙƒÙ…</span>
        </div>
        <div class="eta-info">
            <strong>Ø§Ù„ÙˆØµÙˆÙ„ Ø®Ù„Ø§Ù„: <span id="eta-time">-- Ø¯Ù‚ÙŠÙ‚Ø©</span></strong>
        </div>
    </div>
    
    <div class="atm-panel">
        <h6 class="text-center mb-3 glow-text">ğŸ§ Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø¹Ø±Ø¨ÙŠ ATM</h6>
        <button id="find-nearest-atm-btn" class="btn btn-success-modern w-100 mb-2">ğŸ” Ø£ÙˆØ¬Ø¯ Ø£Ù‚Ø±Ø¨ ATM</button>
        <button id="recenter-btn" class="btn btn-modern w-100 mb-2">ğŸ“ ØªÙˆØ³ÙŠØ· Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
        <button id="nearby-branches-btn" class="btn btn-modern w-100 mb-2">ğŸ¢ Ø§Ø·Ù„Ø¹ Ø¹Ù„Ù‰ Ù…ÙˆØ§Ù‚Ø¹Ù†Ø§ Ø§Ù„Ù‚Ø±ÙŠØ¨Ø© Ù…Ù†Ùƒ</button>
        <div class="form-check form-switch mt-2">
            <input class="form-check-input" type="checkbox" id="auto-center" checked>
            <label class="form-check-label text-white" for="auto-center">
                ØªÙˆØ³ÙŠØ· Ø§Ù„Ø®Ø±ÙŠØ·Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
            </label>
        </div>
    </div>
    
    <div class="location-panel">
        <h6 class="text-center mb-3 glow-text">ğŸ“ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª GPS</h6>
        <div class="info-item">
            <span class="info-label">Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª:</span>
            <span class="info-value" id="coordinates">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ¯...</span>
        </div>
        <div class="info-item">
            <span class="info-label">Ø§Ù„Ø¯Ù‚Ø©:</span>
            <span class="info-value" id="accuracy">-- Ù…ØªØ±</span>
        </div>
        <div class="compass" id="compass"></div>
    </div>

    <div class="travel-mode-panel">
        <button id="mode-car-btn" class="travel-mode-btn active" data-mode="driving">ğŸš—</button>
        <button id="mode-walk-btn" class="travel-mode-btn" data-mode="walking">ğŸš¶â€â™‚ï¸</button>
    </div>

    <!-- Bottom Action Buttons -->
    <div class="bottom-actions">
        <button class="contact-btn email-btn" id="email-btn">ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</button>
        <button class="contact-btn emergency-btn" id="emergency-btn">ğŸ†˜ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</button>
    </div>

    <!-- Right Action Buttons -->
    <div class="right-actions">
        <button class="action-btn export-btn" id="export-btn">
            <i class="fas fa-download"></i> ØªØµØ¯ÙŠØ±
        </button>
        <button class="action-btn feedback-toggle" id="feedback-toggle">
            <i class="fas fa-star"></i> ØªÙ‚ÙŠÙŠÙ…
        </button>
    </div>

    <!-- Nearby Branches Panel -->
    <div class="branches-panel" id="branches-panel">
        <h6>Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù‚Ø±ÙŠØ¨Ø© Ù…Ù†Ùƒ</h6>
        <div class="branches-list" id="branches-list">
            <!-- Will be populated dynamically -->
        </div>
    </div>

    <!-- Emergency Numbers Panel -->
    <div class="emergency-panel" id="emergency-panel">
        <h6>Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</h6>
        <div class="emergency-item">
            <div class="emergency-name">Ø§Ù„Ø´Ø±Ø·Ø©</div>
            <div class="emergency-number">100</div>
        </div>
        <div class="emergency-item">
            <div class="emergency-name">Ø§Ù„Ø¥Ø³Ø¹Ø§Ù</div>
            <div class="emergency-number">101</div>
        </div>
        <div class="emergency-item">
            <div class="emergency-name">Ø§Ù„Ø¯ÙØ§Ø¹ Ø§Ù„Ù…Ø¯Ù†ÙŠ</div>
            <div class="emergency-number">102</div>
        </div>
        <div class="emergency-item">
            <div class="emergency-name">Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
            <div class="emergency-number">022953333</div>
        </div>
    </div>

    <!-- Feedback Panel -->
    <div class="feedback-panel" id="feedback-panel">
        <h6>Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù…Ø´ÙƒÙ„Ø©</h6>
        <form class="feedback-form" id="feedback-form">
            <div class="star-rating" id="star-rating">
                <i class="fas fa-star" data-rating="1"></i>
                <i class="fas fa-star" data-rating="2"></i>
                <i class="fas fa-star" data-rating="3"></i>
                <i class="fas fa-star" data-rating="4"></i>
                <i class="fas fa-star" data-rating="5"></i>
            </div>
            <select id="problem-type" required>
                <option value="" disabled selected>Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©</option>
                <option value="Ø§Ø²Ø¯Ø­Ø§Ù… Ø£Ùˆ Ø·ÙˆØ§Ø¨ÙŠØ± Ø·ÙˆÙŠÙ„Ø©">Ø§Ø²Ø¯Ø­Ø§Ù… Ø£Ùˆ Ø·ÙˆØ§Ø¨ÙŠØ± Ø·ÙˆÙŠÙ„Ø©</option>
                <option value="ØªØ¹Ø·Ù„ Ø§Ù„ØµØ±Ø§Ù Ø£Ùˆ ØªÙˆÙ‚ÙÙ‡ Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„">ØªØ¹Ø·Ù„ Ø§Ù„ØµØ±Ø§Ù Ø£Ùˆ ØªÙˆÙ‚ÙÙ‡ Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„</option>
                <option value="Ù†ÙØ§Ø¯ Ø§Ù„Ù†Ù‚ÙˆØ¯ (ATM Out of Service)">Ù†ÙØ§Ø¯ Ø§Ù„Ù†Ù‚ÙˆØ¯ (ATM Out of Service)</option>
                <option value="Ù†Ø³ÙŠØ§Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø£Ùˆ Ù…Ø´Ø§ÙƒÙ„ ÙÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©">Ù†Ø³ÙŠØ§Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø£Ùˆ Ù…Ø´Ø§ÙƒÙ„ ÙÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</option>
                <option value="Ø¹Ø¯Ù… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©">Ø¹Ø¯Ù… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© (Ù…Ø«Ù„Ø§Ù‹: Ø§Ù†ØªÙ‡Ø§Ø¡ ØµÙ„Ø§Ø­ÙŠØªÙ‡Ø§ Ø£Ùˆ Ø¹Ø¯Ù… ØªÙˆØ§ÙÙ‚Ù‡Ø§)</option>
                <option value="Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø£Ùˆ Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©">Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø£Ùˆ Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</option>
                <option value="Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ Ø£Ùˆ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø´Ø¨ÙƒØ©">Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ Ø£Ùˆ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø´Ø¨ÙƒØ©</option>
                <option value="Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³Ø­ÙˆØ¨">Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³Ø­ÙˆØ¨ (Ù…Ø«Ù„Ø§Ù‹: Ø¹Ø¯Ù… Ø§Ø³ØªÙ„Ø§Ù… ÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ø¨Ù„Øº)</option>
                <option value="ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø³Ø­Ø¨">ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø³Ø­Ø¨ (Ù†Ø³ÙŠØ§Ù†Ù‡Ø§ ÙÙŠ Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©)</option>
                <option value="ØºÙŠØ± Ø°Ù„Ùƒ">ØºÙŠØ± Ø°Ù„Ùƒ</option>
            </select>
            <textarea id="feedback-text" placeholder="Ø£Ø®Ø¨Ø±Ù†Ø§ Ø¨Ø§Ù„Ù…Ø²ÙŠØ¯ Ø¹Ù† Ø§Ù„Ù…Ø´ÙƒÙ„Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
            <button type="submit" class="btn btn-modern">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
            <button type="button" id="cancel-feedback" class="btn btn-danger-modern">Ø¥Ù„ØºØ§Ø¡</button>
        </form>
    </div>

    <script>
        // Initialize Mapbox
        mapboxgl.accessToken = 'pk.eyJ1IjoibW9oYW1tZWQtMTMzMSIsImEiOiJjbHY3dHFsaDcwZWcyMm9xaXBmdHVibm11In0.BDSWP06iKFsCOxq0IwxLBg';
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/navigation-night-v1',
            center: [35.182584, 31.956643], 
            zoom: 15 
        });

        let userLocation = null;
        let userMarker = null;
        let currentRoute = null;
        let destinationMarkers = [];
        let activeDestinationKey = null;
        let travelMode = 'driving'; 
        let currentRating = 0;
        let feedbackData = [];
        let deviceOrientationListenerAttached = false;

        // DOM Elements
        const elements = {
            coordinates: document.getElementById('coordinates'),
            accuracy: document.getElementById('accuracy'),
            speed: document.getElementById('current-speed'),
            compass: document.getElementById('compass'),
            distance: document.getElementById('remaining-distance'),
            eta: document.getElementById('eta-time'),
            autoCenter: document.getElementById('auto-center'),
            feedbackToggle: document.getElementById('feedback-toggle'),
            feedbackPanel: document.getElementById('feedback-panel'),
            feedbackForm: document.getElementById('feedback-form'),
            starRating: document.getElementById('star-rating'),
            stars: document.querySelectorAll('#star-rating i'),
            problemType: document.getElementById('problem-type'),
            feedbackText: document.getElementById('feedback-text'),
            exportBtn: document.getElementById('export-btn'),
            cancelFeedback: document.getElementById('cancel-feedback'),
            findNearestAtmBtn: document.getElementById('find-nearest-atm-btn'),
            recenterBtn: document.getElementById('recenter-btn'),
            nearbyBranchesBtn: document.getElementById('nearby-branches-btn'),
            branchesPanel: document.getElementById('branches-panel'),
            branchesList: document.getElementById('branches-list'),
            emailBtn: document.getElementById('email-btn'),
            emergencyBtn: document.getElementById('emergency-btn'),
            emergencyPanel: document.getElementById('emergency-panel'),
            modeCarBtn: document.getElementById('mode-car-btn'),
            modeWalkBtn: document.getElementById('mode-walk-btn')
        };

        // Destinations data
        const destinations = {
            RamamllhaATM1: { name: "ØµØ±Ø§Ù Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø¹Ø±Ø¨ÙŠ 1", coordinates: [35.1979466, 31.9043281], icon: "ğŸ§", isATM: true },
            RamamllhaATM2: { name: "ØµØ±Ø§Ù Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø¹Ø±Ø¨ÙŠ 2", coordinates: [35.2039468, 31.9047687], icon: "ğŸ§", isATM: true },
            RamamllhaATM3: { name: "ØµØ±Ø§Ù Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø¹Ø±Ø¨ÙŠ 3", coordinates: [35.2103474, 31.9015499], icon: "ğŸ§", isATM: true },
            RamamllhaATM4: { name: "ØµØ±Ø§Ù Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø¹Ø±Ø¨ÙŠ 4", coordinates: [35.2104411, 31.9064525], icon: "ğŸ§", isATM: true },
            RamamllhaATM5: { name: "ØµØ±Ø§Ù Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø¹Ø±Ø¨ÙŠ 5", coordinates: [35.2038083, 31.8937176], icon: "ğŸ§", isATM: true },
            RamamllhaATM6: { name: "ØµØ±Ø§Ù Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø¹Ø±Ø¨ÙŠ 6", coordinates: [35.1774200, 31.8982361], icon: "ğŸ§", isATM: true },
            RamamllhaATM7: { name: "ØµØ±Ø§Ù Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø¹Ø±Ø¨ÙŠ 7", coordinates: [35.2115772, 31.9240344], icon: "ğŸ§", isATM: true },
            RamamllhaATM8: { name: "ØµØ±Ø§Ù Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø¹Ø±Ø¨ÙŠ 8", coordinates: [35.1814044, 31.9598272], icon: "ğŸ§", isATM: true },
            RamamllhaATM9: { name: "ØµØ±Ø§Ù Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø¹Ø±Ø¨ÙŠ 9", coordinates: [35.1931069, 31.9678030], icon: "ğŸ§", isATM: true },
            "al_huda_fuels": { name: "AL_Huda Fuels", coordinates: [35.19880027095686, 31.8855172870815], icon: "â›½", type: "Ù…Ø­Ø·Ø© ÙˆÙ‚ÙˆØ¯" },
            "al_masyoon": { name: "Al masyoon", coordinates: [35.2003326263602, 31.889717724395], icon: "ğŸ¢", type: "Ù…ÙˆÙ‚Ø¹" },
            "millennium_atm": { name: "ØµØ±Ø§Ù Ø§Ù„ÙŠ ÙÙ†Ø¯Ù‚ Ø§Ù„Ù…ÙŠÙ„ÙŠÙ†ÙŠÙˆÙ…", coordinates: [35.2048138891888, 31.89586792292947], icon: "ğŸ§", type: "ØµØ±Ø§Ù Ø¢Ù„ÙŠ" },
            "palestine_medical": { name: "ÙØ±Ø¹ Ù…Ø¬Ù…Ø¹ ÙÙ„Ø³Ø·ÙŠÙ† Ø·Ø¨ÙŠ", coordinates: [35.20598278434559, 31.89902212033414], icon: "ğŸ¥", type: "ÙØ±Ø¹" },
            "ramallah_center": { name: "Ù…Ø±ÙƒØ²ÙŠ Ø±Ø§Ù… Ø§Ù„Ù„Ù‡ ØªØ­ØªØ§", coordinates: [35.1966213415176, 31.90473157911436], icon: "ğŸ¢", type: "ÙØ±Ø¹ Ø±Ø¦ÙŠØ³ÙŠ" },
            "ramallah_al_balad": { name: "Ramallah Al Balad", coordinates: [35.19694313794926, 31.9047933680251], icon: "ğŸ¢", type: "ÙØ±Ø¹" },
            "bravo_market": { name: "Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª Ø¨Ø±Ø§ÙÙˆ", coordinates: [35.18895569811461, 31.90897031567543], icon: "ğŸ›’", type: "Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª" },
            "al_tireh": { name: "AL tireh", coordinates: [35.1862014247212, 31.91177197360297], icon: "ğŸ¢", type: "Ù…ÙˆÙ‚Ø¹" },
            "beituniya": { name: "Ø¨ÙŠØªÙˆÙ†ÙŠØ§", coordinates: [35.17817649101558, 31.89858146338332], icon: "ğŸ¢", type: "Ù…ÙˆÙ‚Ø¹" },
            "clock_roundabout": { name: "Ø¯ÙˆØ§Ø± Ø³Ø§Ø¹Ø©", coordinates: [35.20375563474033, 31.90324281610504], icon: "â±ï¸", type: "Ù…Ø¹Ù„Ù…" },
            "al_ram": { name: "Ø§Ù„Ø±Ø§Ù…", coordinates: [35.22797703941472, 31.84872501996944], icon: "ğŸ¢", type: "Ù…ÙˆÙ‚Ø¹" },
            "khawaja_station": { name: "Ù…Ø­Ø·Ø© Ù„Ø®ÙˆØ§Ø¬Ø§", coordinates: [35.2215153326494, 31.87120989781428], icon: "â›½", type: "Ù…Ø­Ø·Ø© ÙˆÙ‚ÙˆØ¯" },
            "um_sharayet_atm": { name: "ØµØ±Ø§Ù Ø§Ù… Ø´Ø±Ø§ÙŠØ·", coordinates: [35.21164198403004, 31.88875366783402], icon: "ğŸ§", type: "ØµØ±Ø§Ù Ø¢Ù„ÙŠ" },
            "burj_al_sheikh": { name: "Ø¨Ø±Ø¬ Ø§Ù„Ø´ÙŠØ®", coordinates: [35.21045308185135, 31.89983734426793], icon: "ğŸ¢", type: "Ù…Ø¹Ù„Ù…" },
            "national_towers": { name: "Ø§Ø¨Ø±Ø§Ø¬ ÙˆØ·Ù†ÙŠØ©", coordinates: [35.21106937499199, 31.9017672420436], icon: "ğŸ¢", type: "Ù…Ø¹Ù„Ù…" },
            "al_bireh_atm": { name: "Al Bireh Branch ATM", coordinates: [35.21079773282417, 31.906812970405], icon: "ğŸ§", type: "ØµØ±Ø§Ù Ø¢Ù„ÙŠ" },
            "al_bireh_branch": { name: "Al Bireh Branch", coordinates: [35.21080449091851, 31.90684187383359], icon: "ğŸ¦", type: "ÙØ±Ø¹" },
            "central_branch": { name: "Ù…Ø±ÙƒØ²ÙŠ", coordinates: [35.20460755197826, 31.90511348411686], icon: "ğŸ¦", type: "ÙØ±Ø¹ Ø±Ø¦ÙŠØ³ÙŠ" },
            "al_manara_branch": { name: "ÙØ±Ø¹ Ù„Ù…Ù†Ø§Ø±Ø©", coordinates: [35.2046428163957, 31.90505336561647], icon: "ğŸ¦", type: "ÙØ±Ø¹" },
            "ramallah_mall": { name: "Ø±Ø§Ù… Ø§Ù„Ù„Ù‡ Ù…ÙˆÙ„", coordinates: [35.20656381431914, 31.90808420396556], icon: "ğŸ›ï¸", type: "Ù…Ø±ÙƒØ² ØªØ³ÙˆÙ‚" },
            "central_transmission": { name: "Ø§Ù„Ø§Ø±Ø³Ø§Ù„ Ù…Ø±ÙƒØ²ÙŠ", coordinates: [35.20724478446887, 31.91711798293989], icon: "ğŸ“¡", type: "Ù…ÙˆÙ‚Ø¹" },
            "palestine_tower": { name: "Ø§Ù„Ø§Ø±Ø³Ø§Ù„ Ø¨Ø±Ø¬ ÙÙ„Ø³Ø·ÙŠÙ†", coordinates: [35.20721800327197, 31.91716938242694], icon: "ğŸ¢", type: "Ù…Ø¹Ù„Ù…" },
            "al_baloa": { name: "Ø§Ù„Ø¨Ø§Ù„ÙˆØ¹ _Ø§Ù„Ø¨ÙŠØ±Ø©", coordinates: [35.2124992205616, 31.9242874323287], icon: "ğŸ¢", type: "Ù…ÙˆÙ‚Ø¹" },
            "jawwal_area": { name: "Ù…Ù†Ø·Ù‚Ø© Ø´Ø±ÙƒØ© Ø¬ÙˆØ§Ù„ _Ø§Ù„Ø¨ÙŠØ±Ø©", coordinates: [35.2149078950963, 31.92821275469514], icon: "ğŸ“±", type: "Ù…ÙˆÙ‚Ø¹" },
            "mazaya_mall": { name: "Ù…Ø²Ø§ÙŠØ§ Ù…ÙˆÙ„", coordinates: [35.19355319098348, 31.93654676131946], icon: "ğŸ›ï¸", type: "Ù…Ø±ÙƒØ² ØªØ³ÙˆÙ‚" },
            "abu_qash": { name: "Abu Qash", coordinates: [35.1838117021113, 31.95163336160273], icon: "ğŸ¢", type: "Ù…ÙˆÙ‚Ø¹" },
            "bzu_atm": { name: "BZU ATM", coordinates: [35.18139783339325, 31.95984726535798], icon: "ğŸ§", type: "ØµØ±Ø§Ù Ø¢Ù„ÙŠ" },
            "birzeit_atm": { name: "Birzeit ATM", coordinates: [35.19308757761658, 31.967836831381], icon: "ğŸ§", type: "ØµØ±Ø§Ù Ø¢Ù„ÙŠ" },
            "birzeit_branch": { name: "Birzeit Branch", coordinates: [35.19306462925778, 31.96786372766914], icon: "ğŸ¦", type: "ÙØ±Ø¹" },
            "bank_arab": { name: "Bank Arab", coordinates: [35.19329281687995, 31.96917552710591], icon: "ğŸ¦", type: "ÙØ±Ø¹" },
            "rawabi": { name: "Rawabi", coordinates: [35.19013009285347, 32.01137212340873], icon: "ğŸ¢", type: "Ù…ÙˆÙ‚Ø¹" },
            "bayt_rima": { name: "Bayt Rima", coordinates: [35.1034090603974, 32.03893413888758], icon: "ğŸ¢", type: "Ù…ÙˆÙ‚Ø¹" },
            "al_reehan": { name: "Al reehan Beanch", coordinates: [35.16881824290121, 31.9391827522339], icon: "ğŸ¦", type: "ÙØ±Ø¹" },
            "bidu": { name: "Bidu", coordinates: [35.15210575252251, 31.83732408151624], icon: "ğŸ¢", type: "Ù…ÙˆÙ‚Ø¹" },
            "dayr_ibzi": { name: "Dayr Ibzi", coordinates: [35.12528175323867, 31.91814793410924], icon: "ğŸ¢", type: "Ù…ÙˆÙ‚Ø¹" },
            "beit_ur": { name: "Beit Ur al_Tahta", coordinates: [35.09016091506144, 31.8941542954906], icon: "ğŸ¢", type: "Ù…ÙˆÙ‚Ø¹" }
        };

        // Initialize the application
        function initApp() {
            addDestinationMarkers();
            setupEventListeners();
            setupGeolocation();
        }

        // Set up all event listeners
        function setupEventListeners() {
            // Feedback system
            elements.feedbackToggle.addEventListener('click', toggleFeedbackPanel);
            elements.cancelFeedback.addEventListener('click', resetFeedbackForm);
            elements.stars.forEach(star => {
                star.addEventListener('click', setRating);
            });
            elements.feedbackForm.addEventListener('submit', handleFeedbackSubmit);
            
            // Export functionality
            elements.exportBtn.addEventListener('click', exportLocationData);
            
            // Navigation controls
            elements.findNearestAtmBtn.addEventListener('click', findNearestAtmDestination);
            elements.nearbyBranchesBtn.addEventListener('click', toggleNearbyBranches);
            
            // Contact buttons
            elements.emailBtn.addEventListener('click', () => {
                window.location.href = "mailto:support@example.com?subject=Ø§Ø³ØªÙØ³Ø§Ø±";
            });
            elements.emergencyBtn.addEventListener('click', toggleEmergencyPanel);
            
            // Close panels when clicking outside
            document.addEventListener('click', (e) => {
                if (!elements.branchesPanel.contains(e.target) && e.target !== elements.nearbyBranchesBtn) {
                    elements.branchesPanel.style.display = 'none';
                }
                if (!elements.emergencyPanel.contains(e.target) && e.target !== elements.emergencyBtn) {
                    elements.emergencyPanel.style.display = 'none';
                }
                if (!elements.feedbackPanel.contains(e.target) && e.target !== elements.feedbackToggle) {
                    elements.feedbackPanel.style.display = 'none';
                }
            });
            
            // Travel mode buttons
            elements.modeCarBtn.addEventListener('click', () => {
                travelMode = 'driving';
                elements.modeCarBtn.classList.add('active');
                elements.modeWalkBtn.classList.remove('active');
                clearRoute();
                if (activeDestinationKey) {
                    calculateRouteFromCurrent(activeDestinationKey);
                }
            });

            elements.modeWalkBtn.addEventListener('click', () => {
                travelMode = 'walking';
                elements.modeWalkBtn.classList.add('active');
                elements.modeCarBtn.classList.remove('active');
                clearRoute();
                if (activeDestinationKey) {
                    calculateRouteFromCurrent(activeDestinationKey);
                }
            });

            // Recenter button
            elements.recenterBtn.addEventListener('click', () => {
                if (userLocation) {
                    const options = {
                        center: [userLocation.lng, userLocation.lat],
                        zoom: 15
                    };
                    if (elements.autoCenter.checked) {
                        const currentHeading = userMarker && userMarker.getElement().style.transform.includes('rotate') ?
                                                parseFloat(userMarker.getElement().style.transform.replace(/[^\d.-]/g, '')) : null;
                        if (currentHeading !== null && !isNaN(currentHeading)) {
                            options.bearing = currentHeading;
                        }
                        options.pitch = 50; 
                        options.zoom = 16;
                    }
                    map.flyTo(options);
                } else {
                    alert('Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…ØªØ§Ø­ Ø¨Ø¹Ø¯ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ³ÙŠØ·.');
                }
            });

            // Initialize map
            map.on('load', () => {
                if (navigator.geolocation) {
                    navigator.geolocation.watchPosition(
                        updateUserLocation,
                        handleGeolocationError,
                        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                    );
                } else {
                    alert("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ù†Ø¸Ø§Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ØªØµÙØ­ Ø£Ø­Ø¯Ø«.");
                }
            });
        }

        // Toggle nearby branches panel
        function toggleNearbyBranches() {
            if (!userLocation) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ');
                return;
            }
            
            if (elements.branchesPanel.style.display === 'block') {
                elements.branchesPanel.style.display = 'none';
                return;
            }
            
            // Calculate distances and sort branches
            const branchesWithDistance = Object.keys(destinations).map(key => {
                const dest = destinations[key];
                const distance = calculateDistance(
                    userLocation.lat, 
                    userLocation.lng, 
                    dest.coordinates[1], 
                    dest.coordinates[0]
                );
                return {
                    ...dest,
                    key,
                    distance
                };
            }).sort((a, b) => a.distance - b.distance);
            
            // Populate branches list
            elements.branchesList.innerHTML = '';
            branchesWithDistance.forEach(branch => {
                const branchElement = document.createElement('div');
                branchElement.className = 'branch-item';
                branchElement.innerHTML = `
                    <div><strong>${branch.name}</strong></div>
                    <div>${branch.type || (branch.isATM ? 'ØµØ±Ø§Ù Ø¢Ù„ÙŠ' : 'Ù…ÙˆÙ‚Ø¹')}</div>
                    <div class="branch-distance">${branch.distance.toFixed(2)} ÙƒÙ…</div>
                `;
                branchElement.addEventListener('click', () => {
                    calculateRouteFromCurrent(branch.key);
                    elements.branchesPanel.style.display = 'none';
                });
                elements.branchesList.appendChild(branchElement);
            });
            
            elements.branchesPanel.style.display = 'block';
        }

        // Toggle emergency panel
        function toggleEmergencyPanel() {
            elements.emergencyPanel.style.display = 
                elements.emergencyPanel.style.display === 'block' ? 'none' : 'block';
        }

        // Setup geolocation tracking
        function setupGeolocation() {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(
                    updateUserLocation,
                    handleGeolocationError,
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            }
        }

        // Update user location on map
        function updateUserLocation(position) {
            const { latitude, longitude, accuracy, heading, speed } = position.coords;
            
            // Update UI elements
            elements.coordinates.textContent = `${latitude.toFixed(4)}, ${longitude.toFixed(4)}`;
            elements.accuracy.textContent = `${Math.round(accuracy)} Ù…`;
            elements.speed.textContent = speed ? `${(speed * 3.6).toFixed(1)} ÙƒÙ…/Ø³` : "0 ÙƒÙ…/Ø³";
            
            // Update compass
            updateCompass(heading);
            
            // Update user marker
            updateUserMarker(longitude, latitude);
            
            // Auto-center if enabled
            if (elements.autoCenter.checked) {
                centerMap(longitude, latitude, heading);
            }
            
            // Store current location
            userLocation = { lat: latitude, lng: longitude };
        }

        // Update compass direction
        function updateCompass(heading) {
            if (typeof heading === 'number' && !isNaN(heading)) {
                elements.compass.style.transform = `rotate(${heading}deg)`;
            } else if (window.DeviceOrientationEvent && !deviceOrientationListenerAttached) {
                window.addEventListener('deviceorientation', handleOrientation, true);
                deviceOrientationListenerAttached = true;
            }
        }

        // Handle device orientation for compass
        function handleOrientation(event) {
            if (event.alpha !== null) {
                elements.compass.style.transform = `rotate(${-event.alpha}deg)`;
            }
        }

        // Update user marker on map
        function updateUserMarker(lng, lat) {
            if (!userMarker) {
                const el = createUserMarker();
                userMarker = new mapboxgl.Marker(el)
                    .setLngLat([lng, lat])
                    .addTo(map);
            } else {
                userMarker.setLngLat([lng, lat]);
            }
        }

        // Create user marker element
        function createUserMarker() {
            const el = document.createElement('div');
            el.innerHTML = `
                <div style="width: 20px; height: 20px; background: #00ff88; border: 3px solid white; 
                border-radius: 50%; box-shadow: 0 0 15px rgba(0, 255, 136, 0.7);"></div>
            `;
            return el;
        }

        // Center map on user location
        function centerMap(lng, lat, heading) {
            const options = {
                center: [lng, lat],
                zoom: 16,
                pitch: 50,
                essential: true
            };
            
            if (typeof heading === 'number' && !isNaN(heading)) {
                options.bearing = heading;
            }
            
            map.flyTo(options);
        }

        // Handle geolocation errors
        function handleGeolocationError(error) {
            let message;
            switch (error.code) {
                case error.PERMISSION_DENIED: 
                    message = "ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù…ÙˆÙ‚Ø¹Ùƒ.";
                    break;
                case error.POSITION_UNAVAILABLE: 
                    message = "Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ GPS.";
                    break;
                case error.TIMEOUT: 
                    message = "Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø·Ù„Ø¨ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø£Ùˆ Ø¥Ø´Ø§Ø±Ø© GPS.";
                    break;
                default: 
                    message = "Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ/Ù…ØªÙˆÙ‚Ø¹ ÙÙŠ Ù†Ø¸Ø§Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹.";
            }
            
            console.error("GPS Error:", error);
            alert(message);
            
            // Update UI to show error state
            elements.coordinates.textContent = "ØºÙŠØ± Ù…ØªÙˆÙØ±";
            elements.accuracy.textContent = "--";
            elements.speed.textContent = "0 ÙƒÙ…/Ø³";
        }

        // Add destination markers to map
        function addDestinationMarkers() {
            // Clear existing markers
            destinationMarkers.forEach(marker => marker.remove());
            destinationMarkers = [];
            
            // Add new markers
            Object.keys(destinations).forEach(key => {
                const dest = destinations[key];
                const el = document.createElement('div');
                el.innerHTML = `
                    <div style="background: #00ff88; color: white; width: 40px; height: 40px; 
                    border-radius: 50%; display: flex; align-items: center; justify-content: center; 
                    font-size: 1.2rem;">${dest.icon}</div>
                `;
                
                const marker = new mapboxgl.Marker(el)
                    .setLngLat(dest.coordinates)
                    .setPopup(new mapboxgl.Popup().setHTML(`
                        <div style="text-align: center; padding: 10px;">
                            <h6>${dest.name}</h6>
                            <div>${dest.type || (dest.isATM ? 'ØµØ±Ø§Ù Ø¢Ù„ÙŠ' : 'Ù…ÙˆÙ‚Ø¹')}</div>
                            <button onclick="window.calculateRouteFromCurrent('${key}')" 
                                    style="background: #00ff88; color: white; border: none; 
                                           padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-top: 10px;">
                                Ø§Ù†Ø·Ù„Ù‚ Ø¥Ù„Ù‰ Ù‡Ù†Ø§
                            </button>
                        </div>
                    `))
                    .addTo(map);
                
                destinationMarkers.push(marker);
            });
        }

        // Calculate distance between two coordinates
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c; // Distance in km
        }

        // Find nearest ATM destination
        function findNearestAtmDestination() {
            if (!userLocation) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ');
                return;
            }
            
            let nearestDistance = Infinity;
            let nearestAtmKey = null;
            
            Object.keys(destinations).forEach(key => {
                const dest = destinations[key];
                if (dest.isATM) {
                    const distance = calculateDistance(
                        userLocation.lat, 
                        userLocation.lng, 
                        dest.coordinates[1], 
                        dest.coordinates[0]
                    );
                    
                    if (distance < nearestDistance) {
                        nearestDistance = distance;
                        nearestAtmKey = key;
                    }
                }
            });
            
            if (nearestAtmKey) {
                calculateRouteFromCurrent(nearestAtmKey);
                alert(`Ø£Ù‚Ø±Ø¨ ØµØ±Ø§Ù Ù„Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø¹Ù„ÙŠÙƒ Ù‡Ùˆ : ${destinations[nearestAtmKey].name} (${nearestDistance.toFixed(2)} ÙƒÙ…)`);
                activeDestinationKey = nearestAtmKey;
            } else {
                alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ ØµØ±Ø§Ù Ø¢Ù„ÙŠ Ù‚Ø±ÙŠØ¨.');
            }
        }

        // Calculate route from current location to destination
        function calculateRouteFromCurrent(destinationKey) {
            if (!userLocation) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ');
                return;
            }
            if (destinations[destinationKey]) {
                calculateRoute(userLocation, destinations[destinationKey].coordinates, destinations[destinationKey].name);
                activeDestinationKey = destinationKey;
            }
        }

        // Calculate route to destination
        async function calculateRoute(start, end, destinationName) {
            clearRoute();
            try {
                const profile = travelMode === 'driving' ? 'driving' : 'walking'; 
                // Enhanced routing with more detailed geometry for better curve accuracy
                const response = await fetch(
                    `https://api.mapbox.com/directions/v5/mapbox/${profile}/${start.lng},${start.lat};${end[0]},${end[1]}?geometries=geojson&overview=full&steps=true&annotations=distance,duration&continue_straight=false&access_token=${mapboxgl.accessToken}`
                );
                const data = await response.json();
                
                if (data.routes && data.routes.length > 0) {
                    currentRoute = data.routes[0];
                    if (map.getSource('route')) {
                        map.removeLayer('route-glow');
                        map.removeLayer('route');
                        map.removeSource('route');
                    }

                    // Enhanced route styling with glow effect for better visibility
                    map.addSource('route', {
                        type: 'geojson',
                        data: { 
                            type: 'Feature', 
                            properties: {}, 
                            geometry: currentRoute.geometry 
                        }
                    });
                    
                    // Add glow effect layer first (background)
                    map.addLayer({
                        id: 'route-glow', 
                        type: 'line', 
                        source: 'route',
                        layout: { 
                            'line-join': 'round', 
                            'line-cap': 'round' 
                        },
                        paint: { 
                            'line-color': '#00ff88', 
                            'line-width': 8,
                            'line-opacity': 0.4,
                            'line-blur': 2
                        }
                    });
                    
                    // Add main route layer on top
                    map.addLayer({
                        id: 'route', 
                        type: 'line', 
                        source: 'route',
                        layout: { 
                            'line-join': 'round', 
                            'line-cap': 'round' 
                        },
                        paint: { 
                            'line-color': '#00ff88', 
                            'line-width': 4
                        }
                    });
                    
                    const distance = (currentRoute.distance / 1000).toFixed(1);
                    elements.distance.textContent = `${distance} ÙƒÙ…`;
                    const etaMinutes = Math.round(currentRoute.duration / 60);
                    elements.eta.textContent = `${etaMinutes} Ø¯Ù‚ÙŠÙ‚Ø©`;
                    
                    const bounds = new mapboxgl.LngLatBounds();
                    bounds.extend([start.lng, start.lat]);
                    bounds.extend(end);
                    map.fitBounds(bounds, { padding: 50 });
                } else {
                    // Fallback to drawing a direct line if no route is found
                    alert(`Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø³Ø§Ø± Ø¹Ø¨Ø± Ø§Ù„Ø´ÙˆØ§Ø±Ø¹ Ù„Ù€ ${destinationName}. ÙŠØªÙ… Ø¹Ø±Ø¶ Ø®Ø· Ù…Ø¨Ø§Ø´Ø± ÙƒØ¯Ù„ÙŠÙ„ Ø¹Ø§Ù….`);
                    
                    const directLine = {
                        type: 'Feature',
                        properties: {},
                        geometry: {
                            type: 'LineString',
                            coordinates: [
                                [start.lng, start.lat],
                                [end[0], end[1]]
                            ]
                        }
                    };

                    if (map.getSource('route')) {
                        map.removeLayer('route-glow');
                        map.removeLayer('route');
                        map.removeSource('route');
                    }
                    map.addSource('route', {
                        type: 'geojson',
                        data: directLine
                    });
                    map.addLayer({
                        id: 'route', type: 'line', source: 'route',
                        layout: { 'line-join': 'round', 'line-cap': 'round' },
                        paint: { 
                            'line-color': '#FFD700',
                            'line-width': 3,
                            'line-dasharray': [1, 2]
                        }
                    });

                    const distance = calculateDistance(start.lat, start.lng, end[1], end[0]).toFixed(1);
                    elements.distance.textContent = `${distance} ÙƒÙ… (Ø®Ø· Ù…Ø¨Ø§Ø´Ø±)`;
                    const estimatedSpeedKmH = (travelMode === 'walking' ? 5 : 40);
                    const etaMinutes = Math.round((distance / estimatedSpeedKmH) * 60);
                    elements.eta.textContent = `${etaMinutes} Ø¯Ù‚ÙŠÙ‚Ø© (ØªÙ‚Ø¯ÙŠØ±ÙŠ)`;

                    const bounds = new mapboxgl.LngLatBounds();
                    bounds.extend([start.lng, start.lat]);
                    bounds.extend(end);
                    map.fitBounds(bounds, { padding: 50 });
                }
            } catch (error) {
                console.error('Route calculation error:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§Ø±. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹. Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø®Ø· Ù…Ø¨Ø§Ø´Ø± Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø°Ù„Ùƒ.');

                const directLine = {
                    type: 'Feature',
                    properties: {},
                    geometry: {
                        type: 'LineString',
                        coordinates: [
                            [start.lng, start.lat],
                            [end[0], end[1]]
                        ]
                    }
                };

                if (map.getSource('route')) {
                    map.removeLayer('route-glow');
                    map.removeLayer('route');
                    map.removeSource('route');
                }
                map.addSource('route', {
                    type: 'geojson',
                    data: directLine
                });
                map.addLayer({
                    id: 'route', type: 'line', source: 'route',
                    layout: { 'line-join': 'round', 'line-cap': 'round' },
                    paint: { 
                        'line-color': '#FFD700',
                        'line-width': 3,
                        'line-dasharray': [1, 2]
                    }
                });

                const distance = calculateDistance(start.lat, start.lng, end[1], end[0]).toFixed(1);
                elements.distance.textContent = `${distance} ÙƒÙ… (Ø®Ø· Ù…Ø¨Ø§Ø´Ø±)`;
                const estimatedSpeedKmH = (travelMode === 'walking' ? 5 : 40);
                const etaMinutes = Math.round((distance / estimatedSpeedKmH) * 60);
                elements.eta.textContent = `${etaMinutes} Ø¯Ù‚ÙŠÙ‚Ø© (ØªÙ‚Ø¯ÙŠØ±ÙŠ)`;

                const bounds = new mapboxgl.LngLatBounds();
                bounds.extend([start.lng, start.lat]);
                bounds.extend(end);
                map.fitBounds(bounds, { padding: 50 });
            }
        }

        // Clear current route
        function clearRoute() {
            if (map.getSource('route')) {
                if (map.getLayer('route-glow')) {
                    map.removeLayer('route-glow');
                }
                map.removeLayer('route');
                map.removeSource('route');
                elements.distance.textContent = '-- ÙƒÙ…';
                elements.eta.textContent = '-- Ø¯Ù‚ÙŠÙ‚Ø©';
                currentRoute = null;
                activeDestinationKey = null;
            }
        }

        // Feedback system functions
        function toggleFeedbackPanel() {
            elements.feedbackPanel.style.display = 
                elements.feedbackPanel.style.display === 'block' ? 'none' : 'block';
        }

        function setRating(e) {
            const rating = parseInt(e.target.getAttribute('data-rating'));
            currentRating = rating;
            
            elements.stars.forEach((star, i) => {
                if (i < rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }

        function handleFeedbackSubmit(e) {
            e.preventDefault();
            
            const problemTypeValue = elements.problemType.value;
            const feedbackTextValue = elements.feedbackText.value;
            
            if (!problemTypeValue) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©');
                return;
            }
            
            // Create feedback object
            const feedback = {
                rating: currentRating,
                problemType: problemTypeValue,
                feedbackText: feedbackTextValue,
                location: userLocation,
                timestamp: new Date().toISOString()
            };
            
            // Store feedback
            feedbackData.push(feedback);
            console.log('Feedback submitted:', feedback);
            
            // Show confirmation and reset form
            alert('Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ Ø¹Ù„Ù‰ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ! ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø´ÙƒÙ„Ø©.');
            resetFeedbackForm();
        }

        function resetFeedbackForm() {
            elements.feedbackForm.reset();
            elements.stars.forEach(star => star.classList.remove('active'));
            currentRating = 0;
            elements.feedbackPanel.style.display = 'none';
        }

        // Export location data
        function exportLocationData() {
            if (!userLocation) {
                alert('Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…ØªØ§Ø­ Ø¨Ø¹Ø¯ Ù„Ù„ØªØµØ¯ÙŠØ±');
                return;
            }
            
            // Create GeoJSON data
            const geoData = {
                type: "FeatureCollection",
                features: [
                    {
                        type: "Feature",
                        properties: {
                            name: "Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ",
                            timestamp: new Date().toISOString(),
                            speed: elements.speed.textContent,
                            accuracy: elements.accuracy.textContent
                        },
                        geometry: {
                            type: "Point",
                            coordinates: [userLocation.lng, userLocation.lat]
                        }
                    }
                ]
            };
            
            // Include feedback data if available
            if (feedbackData.length > 0) {
                geoData.features.push({
                    type: "Feature",
                    properties: {
                        name: "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª",
                        feedbacks: feedbackData
                    },
                    geometry: {
                        type: "Point",
                        coordinates: [userLocation.lng, userLocation.lat]
                    }
                });
            }
            
            // Convert to JSON string
            const dataStr = JSON.stringify(geoData, null, 2);
            
            // Create download link
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = `Ù…ÙˆÙ‚Ø¹_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            alert('ØªÙ… ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­!');
        }

        // Initialize the application
        initApp();

        // Make functions available globally
        window.calculateRouteFromCurrent = calculateRouteFromCurrent;
        window.clearRoute = clearRoute;
    </script>
</body>
</html>
